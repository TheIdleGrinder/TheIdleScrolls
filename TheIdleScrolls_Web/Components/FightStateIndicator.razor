@using TheIdleScrolls_Web.CoreWrapper

@inject CoreWrapperModel CoreWrapper

<div class="fightOuter">
    <div id="imageContainer">
        <img src="/images/hourglass_broadsword.png" class="pixelart" style="width: 256px" />
    </div>
    
    @if (MobPresent)
    {
        <div class="fightInner">
            <p style="margin-bottom: 0px;">@CoreWrapper.Mob.Name (Level @CoreWrapper.Mob.Level)</p>
            <p class="healthText">HP: @Hp.ToBigIntString() / @HpMax.ToBigIntString()</p>
            <div class="progressFrame">
                <div class="progressFill healthBar" style="width: @(PctString(Hp, HpMax));"></div>
            </div>
        </div>
    }
    
    @if (TimeActive)
    {
        <div class="fightInner" style="margin-top: 1rem;">
            <p class="timeText">Remaining: @(GetTimeString(Time)) / @(GetTimeString(TimeMax))</p>
            <div class="progressFrame">
                <div class="progressFill timeBar" style="width: @(PctString(Time, TimeMax));"></div>
            </div>
        </div>
    }

    <div class="progress-bar-container" style="margin-top: 1rem;">
        Atk
        <div id="attack-bar-frame" class="progressFrame" style="justify-content: start">
            <div id="attack-bar-fill" class="progressFill" style="width: @($"{AttackPct:0%}");"></div>
        </div>
    </div>
    
</div>

<style>
    #imageContainer {
        width: 100%;
        padding: 25px;
        display: flex;
        flex-direction: row;
        justify-content: center;
    }

    div.fightOuter {
        width: 100%;
        display: flex;
        flex-direction: column;
        padding: 0.5rem;
        background-color: var(--back-color);
    }

    div.fightInner {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 10px;
    }

    .timeBar {
        background-color: var(--color-time);
    }

    .timeText {
        color: var(--color-time);
        margin-bottom: 0px;
    }

    .healthBar {
        background-color: var(--color-hp);
    }

    .healthText {
        color: var(--color-hp);
        margin-bottom: 0px;
    }

    .progress-bar-container {
        display: inline-flex;
        gap: 0.5rem;
        font-size: 1.25rem;
    }

    #attack-bar-frame {
        width: 100%;
        border: 1px solid var(--frame-color);
        background: inherit;
        height: fit-content;
        align-self: center;
    }

    #attack-bar-fill {
        background-color: var(--color-attack-progress);
        height: 12px;
    }
</style>

@code {
    bool MobPresent => CoreWrapper.Mob.HP > 0;
    bool TimeActive => CoreWrapper.TimeLimit.Maximum > 0.0;

    int Hp => CoreWrapper.Mob.HP;
    int HpMax => CoreWrapper.Mob.HpMax;
    double Time => CoreWrapper.TimeLimit.Remaining;
    double TimeMax => CoreWrapper.TimeLimit.Maximum;

    double AttackPct => 1.0 - 1.0 * CoreWrapper.CharacterStats.CooldownRemaining / CoreWrapper.CharacterStats.Cooldown;

    protected override void OnInitialized()
    {
        CoreWrapper.StateChanged += StateHasChanged;
        base.OnInitialized();
    }

    string GetTimeString(double time)
    {
        return $"{time:0.###} s";
    }

    string PctString(double current, double max)
    {
        return $"{current / max:0%}";
    }

    int TimeToInt(double time)
    {
        return (int)(time * 1000);
    }
}
