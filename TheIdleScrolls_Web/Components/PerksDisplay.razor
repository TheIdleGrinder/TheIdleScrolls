@using TheIdleScrolls_Core
@using TheIdleScrolls_Core.Components
@using TheIdleScrolls_Core.Modifiers
@using TheIdleScrolls_Web.CoreWrapper

@inject CoreWrapperModel CoreWrapper

<div id="perks-container">

    <div class="perks-list">
        @foreach (var perk in Perks.Where(p => p.Modifiers.Count > 0))
        {
            Console.WriteLine(perk.Id);
            <PerkTile PerkId=@perk.Id PerksComp=@PerksComponent />
        }
    </div>

    <div id="perks-header">
        <p style="margin-bottom: 0">Points Spent: @PerksUsed / @PerksLimit</p>
        @if (FreePerkPoints > 0)
        {
            <p id="perks-available-points">@FreePerkPoints Point@(FreePerkPoints == 1 ? "" : "s") Available</p>
        }
    </div>

</div>


<style>
    #perks-container {
        display: flex;
        flex-direction: column;
        max-height: 100%;
        overflow-y: auto;
    }

    #perks-header {
        padding: 1.0rem;
        border-top: 2px double var(--frame-color);
        display: flex;
        flex-direction: row;
        justify-content: space-between;
    }

    #perks-available-points {
        margin-left: 2rem;
        margin-bottom: 0;
        font-weight: bold;
        color: green;        
    }

    .perks-list {
        padding: 5px;
        max-height: 100%;
        overflow-y: auto;
    }
</style>

@code {
    protected override void OnInitialized()
    {
        CoreWrapper.GameRunner.GetEventEmitter().PlayerPerksChanged += (_) => {
            if (PerksComponent == null)
                PerksComponent = CoreWrapper.PlayerCharacter?.GetComponent<PerksComponent>();
            StateHasChanged(); 
        };
        CoreWrapper.GameRunner.GetEventEmitter().AvailablePerkPointsChanged += (_) => StateHasChanged();
        base.OnInitialized();
        PerksComponent = CoreWrapper.PlayerCharacter?.GetComponent<PerksComponent>();
    }

    PerksComponent? PerksComponent = null;
    List<Perk> Perks => PerksComponent?.GetPerks() ?? [];
    int PerksUsed => PerksComponent?.GetUsedPerkPoints() ?? 0;
    int PerksLimit => PerksComponent?.PerkPointLimit ?? 0;
    int FreePerkPoints => PerksLimit - PerksUsed;
}
